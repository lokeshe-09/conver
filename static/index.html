<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Chat Application</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-window {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 10px;
            background-color: #f1f5f9;
            border-bottom: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .chat-input {
            padding: 10px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="login-form" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 class="text-2xl font-bold mb-6 text-center">Enter Chat Room</h2>
            <input type="text" id="username" placeholder="Username" required class="w-full p-2 mb-4 border rounded">
            <input type="number" id="age" placeholder="Age" required class="w-full p-2 mb-4 border rounded">
            <select id="gender" required class="w-full p-2 mb-4 border rounded">
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
            </select>
            <button id="login-button" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Enter Chat</button>
        </div>
    </div>

    <div id="chat-interface" class="hidden">
        <div class="container mx-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Professional Chat Room</h2>
                <button id="profile-button" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">My Profile</button>
            </div>
            <div class="flex">
                <div class="w-1/4 bg-white p-4 rounded-lg shadow-md mr-4">
                    <h3 class="text-xl font-bold mb-4">Online Users</h3>
                    <ul id="online-users" class="mb-8"></ul>
                    <h3 class="text-xl font-bold mb-4">Groups</h3>
                    <ul id="groups" class="mb-4"></ul>
                    <input type="text" id="new-group" placeholder="New Group Name" class="w-full p-2 mb-2 border rounded">
                    <button id="create-group" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Create Group</button>
                </div>
                <div class="w-3/4 bg-white p-4 rounded-lg shadow-md">
                    <div id="chat-messages" class="h-96 overflow-y-auto mb-4 p-4 border rounded"></div>
                    <div class="flex">
                        <input type="text" id="user-input" placeholder="Type your message..." class="flex-grow p-2 border rounded-l">
                        <button id="send-button" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const loginForm = document.getElementById('login-form');
        const chatInterface = document.getElementById('chat-interface');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const onlineUsersList = document.getElementById('online-users');
        const groupsList = document.getElementById('groups');
        const newGroupInput = document.getElementById('new-group');
        const createGroupButton = document.getElementById('create-group');
        const profileButton = document.getElementById('profile-button');

        let currentUser;
        let ws;
        let currentChat = 'main';
        let chatWindows = {};

        document.getElementById('login-button').onclick = async function() {
            const username = document.getElementById('username').value;
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;

            if (!username || !age || !gender) {
                alert('Please fill in all fields');
                return;
            }

            const response = await fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, age: parseInt(age), gender }),
            });

            if (response.ok) {
                currentUser = username;
                loginForm.style.display = 'none';
                chatInterface.style.display = 'block';
                initializeWebSocket();
                fetchOnlineUsers();
                fetchGroups();
            } else {
                const error = await response.json();
                alert(error.detail);
            }
        };

        function initializeWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws/${currentUser}`);

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                if (message.type === 'chat') {
                    if (message.receiver === 'main') {
                        appendMessage(chatMessages, message.sender, message.content);
                    } else if (message.receiver.startsWith('group:')) {
                        const groupName = message.receiver.split(':')[1];
                        if (chatWindows[groupName]) {
                            appendMessage(chatWindows[groupName].messages, message.sender, message.content);
                        }
                    } else {
                        if (chatWindows[message.sender]) {
                            appendMessage(chatWindows[message.sender].messages, message.sender, message.content);
                        } else {
                            createChatWindow(message.sender);
                            appendMessage(chatWindows[message.sender].messages, message.sender, message.content);
                        }
                    }
                } else if (message.type === 'system') {
                    appendMessage(chatMessages, 'System', message.content);
                }
            };
        }

        async function fetchOnlineUsers() {
            const response = await fetch('/online_users');
            const data = await response.json();
            onlineUsersList.innerHTML = '';
            data.online_users.forEach(user => {
                if (user.username !== currentUser) {
                    const li = document.createElement('li');
                    li.className = 'mb-2 cursor-pointer hover:text-blue-500';
                    li.innerHTML = `${getGenderEmoji(user.gender)} ${user.username}`;
                    li.onclick = () => startPersonalChat(user.username);
                    onlineUsersList.appendChild(li);
                }
            });
        }

        function getGenderEmoji(gender) {
            switch(gender) {
                case 'male': return 'ðŸ‘¨';
                case 'female': return 'ðŸ‘©';
                default: return 'ðŸ§‘';
            }
        }

        async function fetchGroups() {
            const response = await fetch('/groups');
            const data = await response.json();
            groupsList.innerHTML = '';
            data.groups.forEach(group => {
                const li = document.createElement('li');
                li.className = 'mb-2 cursor-pointer hover:text-blue-500';
                li.textContent = group;
                li.onclick = () => joinGroup(group);
                groupsList.appendChild(li);
            });
        }

        function startPersonalChat(user) {
            if (!chatWindows[user]) {
                createChatWindow(user);
            }
        }

        function joinGroup(group) {
            if (!chatWindows[group]) {
                createChatWindow(group, true);
            }
            ws.send(JSON.stringify({ type: 'join_group', group_name: group }));
        }

        function createChatWindow(name, isGroup = false) {
            const chatWindow = document.createElement('div');
            chatWindow.className = 'chat-window';
            chatWindow.innerHTML = `
                <div class="chat-header">
                    <span>${isGroup ? 'ðŸ‘¥' : 'ðŸ‘¤'} ${name}</span>
                    <button class="close-btn float-right">&times;</button>
                </div>
                <div class="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" placeholder="Type a message..." class="w-<input type="text" placeholder="Type a message..." class="w-full p-2 border rounded">
                </div>
            `;
            document.body.appendChild(chatWindow);

            const messagesContainer = chatWindow.querySelector('.chat-messages');
            const input = chatWindow.querySelector('input');
            const closeBtn = chatWindow.querySelector('.close-btn');

            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    sendMessage(name, input.value, isGroup);
                    input.value = '';
                }
            };

            closeBtn.onclick = function() {
                document.body.removeChild(chatWindow);
                delete chatWindows[name];
            };

            chatWindows[name] = {
                window: chatWindow,
                messages: messagesContainer,
                input: input
            };
        }

        createGroupButton.onclick = function() {
            const groupName = newGroupInput.value.trim();
            if (groupName) {
                ws.send(JSON.stringify({ type: 'create_group', group_name: groupName }));
                newGroupInput.value = '';
                fetchGroups();
            }
        };

        profileButton.onclick = async function() {
            const response = await fetch(`/user_profile/${currentUser}`);
            const profile = await response.json();
            alert(`Username: ${profile.username}\nAge: ${profile.age}\nGender: ${profile.gender}`);
        };

        function sendMessage(receiver, content, isGroup = false) {
            if (content) {
                const message = {
                    type: 'chat',
                    receiver: isGroup ? `group:${receiver}` : receiver,
                    content: content
                };
                ws.send(JSON.stringify(message));
                
                if (receiver === 'main') {
                    appendMessage(chatMessages, currentUser, content);
                } else {
                    appendMessage(chatWindows[receiver].messages, currentUser, content);
                }
            }
        }

        function appendMessage(container, sender, content) {
            const messageElement = document.createElement('div');
            messageElement.className = 'mb-2';
            messageElement.innerHTML = `<strong>${sender}:</strong> ${content}`;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        sendButton.onclick = function() {
            sendMessage('main', userInput.value);
            userInput.value = '';
        };

        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage('main', userInput.value);
                userInput.value = '';
            }
        });

        setInterval(fetchOnlineUsers, 10000);
        setInterval(fetchGroups, 10000);
    </script>
</body>
</html>